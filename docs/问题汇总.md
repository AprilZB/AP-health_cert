# 问题汇总

## 📋 目录

- [常见问题](#常见问题)
- [部署问题](#部署问题)
- [功能问题](#功能问题)
- [性能问题](#性能问题)
- [已知Bug](#已知bug)
- [解决方案](#解决方案)

---

## 常见问题

### Q1: 如何重置管理员密码？

**问题描述**: 忘记管理员密码，无法登录系统。

**解决方案**:

```bash
# 方法1：通过数据库重置
docker-compose exec mysql mysql -uroot -proot123 health_cert_db << EOF
UPDATE admins SET password = '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iwy8pJ5C' WHERE username = 'admin';
EOF
# 密码重置为: admin123

# 方法2：使用BCrypt在线工具生成新密码
# 访问: https://www.bcrypt-generator.com/
# 生成后更新数据库
```

---

### Q2: 如何查看系统日志？

**问题描述**: 需要查看系统运行日志进行故障排查。

**解决方案**:

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看后端服务日志
docker-compose logs -f backend

# 查看最近100行日志
docker-compose logs --tail=100 backend

# 查看错误日志
docker-compose logs backend | grep -i error

# 查看特定时间段的日志
docker-compose logs --since 30m backend
```

---

### Q3: 如何修改端口号？

**问题描述**: 80端口被占用，需要修改访问端口。

**解决方案**:

编辑 `docker-compose.yml`:

```yaml
nginx:
  ports:
    - "8080:80"  # 修改为8080端口
```

然后重启服务：

```bash
docker-compose restart nginx
```

访问地址变为: http://localhost:8080

---

### Q4: 如何增加上传文件大小限制？

**问题描述**: 上传大图片时提示文件过大。

**解决方案**:

1. **修改Nginx配置** (`docker/nginx/nginx.conf`):

```nginx
http {
    client_max_body_size 20M;  # 增加到20MB
}
```

2. **修改Spring Boot配置** (`application.yml`):

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 20MB
```

3. **重启服务**:

```bash
docker-compose restart nginx backend
```

---

## 部署问题

### 问题1: Docker服务无法启动

**症状**: `docker-compose up -d` 后服务状态为 `Exit` 或 `Restarting`

**排查步骤**:

```bash
# 1. 查看服务日志
docker-compose logs backend
docker-compose logs mysql

# 2. 检查端口占用
netstat -tuln | grep -E '80|8080|3306'

# 3. 检查磁盘空间
df -h

# 4. 检查Docker服务
docker info
```

**常见原因**:
- 端口被占用：修改`docker-compose.yml`中的端口映射
- 磁盘空间不足：清理Docker镜像和容器
- 内存不足：增加系统内存或调整JVM参数

---

### 问题2: MySQL连接失败

**症状**: 后端日志显示 `Communications link failure` 或 `Access denied`

**排查步骤**:

```bash
# 1. 检查MySQL服务状态
docker-compose ps mysql

# 2. 检查MySQL日志
docker-compose logs mysql

# 3. 测试MySQL连接
docker-compose exec mysql mysql -uroot -proot123 -e "SELECT 1"

# 4. 检查数据库是否存在
docker-compose exec mysql mysql -uroot -proot123 -e "SHOW DATABASES;"
```

**解决方案**:

```bash
# 如果MySQL未启动，重启MySQL
docker-compose restart mysql

# 等待30-60秒后重试
# 如果仍然失败，检查密码配置
```

---

### 问题3: 后端服务启动失败

**症状**: Backend容器频繁重启

**排查步骤**:

```bash
# 1. 查看后端日志
docker-compose logs backend

# 2. 检查数据库连接
docker-compose exec backend wget -qO- http://localhost:8080/api/auth/health

# 3. 检查JVM内存
docker stats health-cert-backend
```

**常见原因**:
- 数据库未启动：先启动MySQL
- 内存不足：增加JVM内存限制
- 配置文件错误：检查`application.yml`

**解决方案**:

```bash
# 增加JVM内存（修改docker-compose.yml）
environment:
  JAVA_OPTS: "-Xms1024m -Xmx2048m -Dfile.encoding=UTF-8"

# 重启服务
docker-compose restart backend
```

---

### 问题4: Nginx无法访问后端

**症状**: 访问系统时显示502 Bad Gateway

**排查步骤**:

```bash
# 1. 检查后端服务状态
docker-compose ps backend

# 2. 检查后端健康检查
curl http://localhost:8080/api/auth/health

# 3. 检查Nginx配置
docker-compose exec nginx nginx -t

# 4. 查看Nginx日志
docker-compose logs nginx
```

**解决方案**:

```bash
# 重启后端服务
docker-compose restart backend

# 等待后端启动完成后重启Nginx
docker-compose restart nginx
```

---

## 功能问题

### 问题1: OCR识别失败

**症状**: 上传图片后OCR识别返回空结果或超时

**排查步骤**:

```bash
# 1. 检查OCR服务地址配置
docker-compose exec backend cat /app/application.yml | grep ocr

# 2. 测试OCR服务连通性
docker-compose exec backend wget -O- http://10.11.100.238:8081/ocr

# 3. 查看后端日志
docker-compose logs backend | grep -i ocr
```

**常见原因**:
- OCR服务地址错误：检查`application.yml`中的`ocr.service.url`配置
- OCR服务不可访问：检查网络连接和防火墙设置
- 图片格式不支持：确保上传JPG/PNG/BMP格式
- 图片过大：压缩图片或增加超时时间

**解决方案**:

```yaml
# 修改application.yml，增加超时时间
ocr:
  service:
    url: http://10.11.100.238:8081/ocr
    timeout: 60000  # 增加到60秒
```

---

### 问题2: 图片无法显示

**症状**: 健康证图片无法加载或显示404错误

**排查步骤**:

```bash
# 1. 检查图片文件是否存在
docker-compose exec backend ls -la /app/uploads

# 2. 检查Nginx配置
docker-compose exec nginx cat /etc/nginx/nginx.conf | grep uploads

# 3. 测试图片URL
curl http://localhost/uploads/2025/12/test.jpg
```

**解决方案**:

```bash
# 检查Nginx配置中的uploads路径
# 确保nginx.conf中有以下配置：
location ^~ /uploads {
    proxy_pass http://backend;
    expires 1d;
}

# 重启Nginx
docker-compose restart nginx
```

---

### 问题3: 员工同步失败

**症状**: 手动触发同步或定时同步失败

**排查步骤**:

```bash
# 1. 查看同步日志
docker-compose logs backend | grep -i sync

# 2. 检查远程数据库连接
# 查看application.yml中的远程数据源配置

# 3. 测试远程数据库连接
docker-compose exec backend ping <远程数据库IP>
```

**常见原因**:
- 远程数据库不可访问：检查网络连接
- 远程数据库账号密码错误：检查配置
- 同步锁未释放：重启后端服务

**解决方案**:

```bash
# 重启后端服务释放锁
docker-compose restart backend

# 检查远程数据库配置
# 确保application.yml中的remote数据源配置正确
```

---

### 问题4: 邮件发送失败

**症状**: 健康证到期提醒邮件发送失败

**排查步骤**:

```bash
# 1. 查看邮件发送日志
docker-compose logs backend | grep -i mail

# 2. 检查邮件配置
# 登录系统 -> 系统配置 -> 邮件配置

# 3. 测试邮件发送
# 在系统配置页面点击"测试发送"
```

**常见原因**:
- SMTP配置错误：检查SMTP服务器地址、端口、账号密码
- 防火墙阻止：检查SMTP端口是否开放
- 邮件服务器要求SSL/TLS：启用SSL/TLS选项

**解决方案**:

1. 检查SMTP配置：
   - SMTP服务器地址
   - SMTP端口（25/465/587）
   - 用户名和密码
   - 是否启用SSL/TLS

2. 测试连接：
   ```bash
   # 使用telnet测试SMTP连接
   telnet smtp.example.com 25
   ```

---

### 问题5: 钉钉消息发送失败

**症状**: 健康证到期提醒钉钉消息发送失败

**排查步骤**:

```bash
# 1. 查看钉钉发送日志
docker-compose logs backend | grep -i dingtalk

# 2. 检查钉钉配置
# 登录系统 -> 系统配置 -> 钉钉配置
```

**常见原因**:
- Corp ID或App Secret错误：检查配置
- Token获取失败：检查网络连接
- 用户ID不存在：检查员工钉钉ID是否正确

**解决方案**:

1. 检查钉钉配置：
   - Corp ID
   - App Secret
   - 确保员工信息中有正确的钉钉用户ID

2. 测试Token获取：
   ```bash
   # 查看后端日志中的Token获取信息
   docker-compose logs backend | grep -i token
   ```

---

## 性能问题

### 问题1: 页面加载缓慢

**症状**: 打开页面时加载时间过长

**可能原因**:
- 数据库查询慢
- 网络延迟
- 服务器资源不足

**解决方案**:

```bash
# 1. 检查数据库查询性能
docker-compose exec mysql mysql -uroot -proot123 health_cert_db -e "SHOW PROCESSLIST;"

# 2. 优化数据库索引
# 检查是否有慢查询，添加必要的索引

# 3. 增加服务器资源
# 增加CPU和内存
```

---

### 问题2: 导出功能超时

**症状**: 导出大量数据时超时

**解决方案**:

```yaml
# 增加导出超时时间（application.yml）
spring:
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB
```

---

## 已知Bug

### Bug1: OCR识别大图片超时

**描述**: 上传大图片（如TEST1.jpg）时，OCR识别可能超时。

**影响**: 中等

**临时解决方案**:
- 压缩图片后再上传
- 增加OCR服务超时时间配置

**计划修复**: v1.1.0

---

### Bug2: 图片预览在某些浏览器不支持

**描述**: 全屏预览功能在某些浏览器（如IE）不支持。

**影响**: 低

**临时解决方案**:
- 使用Chrome/Firefox/Edge浏览器

**计划修复**: v1.1.0

---

### Bug3: 分页在某些情况下不准确

**描述**: 当数据量很大时，分页总数可能不准确。

**影响**: 低

**临时解决方案**:
- 刷新页面
- 使用筛选条件减少数据量

**计划修复**: v1.1.0

---

## 解决方案

### 通用排查流程

1. **查看日志**: `docker-compose logs -f`
2. **检查服务状态**: `docker-compose ps`
3. **检查资源使用**: `docker stats`
4. **检查网络连接**: `ping` / `telnet`
5. **检查配置文件**: 确认配置正确

### 紧急恢复

如果系统完全无法访问：

```bash
# 1. 停止所有服务
docker-compose down

# 2. 检查数据卷
docker volume ls | grep health-cert

# 3. 重新启动服务
docker-compose up -d

# 4. 查看启动日志
docker-compose logs -f
```

### 联系支持

如果以上方案都无法解决问题，请：

1. 收集以下信息：
   - 错误日志：`docker-compose logs > error.log`
   - 服务状态：`docker-compose ps`
   - 系统信息：`docker info`
   - 问题描述和复现步骤

2. 提交Issue到GitHub仓库

---

**最后更新**: 2024年12月26日

