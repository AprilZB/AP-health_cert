# å¥åº·è¯ç¼–å·é‡å¤é€»è¾‘è°ƒæ•´è¯´æ˜

## ğŸ“‹ è°ƒæ•´èƒŒæ™¯

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå¥åº·è¯ç¼–å·éœ€è¦æ”¯æŒé‡å¤ï¼Œä»¥è®°å½•åŒä¸€ç¼–å·çš„å¤šæ¬¡æäº¤å†å²ã€‚ä½†ç”Ÿæ•ˆçš„å¥åº·è¯ï¼ˆ`is_current=1`ï¼‰ä¸­ï¼Œæ¯ä¸ªç¼–å·åªèƒ½æœ‰ä¸€ä¸ªã€‚

## ğŸ”„ ä¸šåŠ¡é€»è¾‘è°ƒæ•´

### 1. æ•°æ®åº“è°ƒæ•´

**ä¿®æ”¹å‰ï¼š**
- `cert_number` å­—æ®µæœ‰å”¯ä¸€ç´¢å¼• `UNIQUE KEY uk_cert_number`
- å¥åº·è¯ç¼–å·å…¨å±€å”¯ä¸€ï¼Œä¸å…è®¸é‡å¤

**ä¿®æ”¹åï¼š**
- ç§»é™¤ `cert_number` çš„å”¯ä¸€ç´¢å¼•
- æ·»åŠ æ™®é€šç´¢å¼• `idx_cert_number` å’Œå¤åˆç´¢å¼• `idx_cert_number_is_current`
- é€šè¿‡åº”ç”¨å±‚ä¿è¯ï¼š`is_current=1` æ—¶ï¼Œ`cert_number` å”¯ä¸€

**è¿ç§»è„šæœ¬ï¼š**
- æ–‡ä»¶ï¼š`health-cert-backend/src/main/resources/sql/migration_remove_cert_number_unique.sql`
- æ‰§è¡Œæ–¹å¼ï¼šæ‰‹åŠ¨æ‰§è¡Œæˆ–é€šè¿‡æ•°æ®åº“ç®¡ç†å·¥å…·æ‰§è¡Œ

### 2. æäº¤é€»è¾‘è°ƒæ•´

**ä¿®æ”¹å‰ï¼š**
- å¦‚æœç¼–å·å·²å­˜åœ¨ä¸”çŠ¶æ€ä¸º `rejected`ï¼Œå…è®¸é‡æ–°æäº¤ï¼ˆæ›´æ–°è®°å½•ï¼‰
- å¦‚æœç¼–å·å·²å­˜åœ¨ä¸”çŠ¶æ€ä¸æ˜¯ `rejected`ï¼Œä¸å…è®¸é‡å¤æäº¤

**ä¿®æ”¹åï¼š**
- å…è®¸ç¼–å·é‡å¤ï¼ˆæ”¯æŒå†å²è®°å½•ï¼‰
- å¦‚æœç¼–å·å·²å­˜åœ¨ä¸” `is_current=1`ï¼Œå…ˆå°†æ—§çš„è®¾ä¸º `is_current=0`
- å¦‚æœå­˜åœ¨ç›¸åŒç¼–å·ä¸”çŠ¶æ€ä¸º `rejected` çš„è®°å½•ï¼Œæ›´æ–°è¯¥è®°å½•ï¼ˆé‡æ–°æäº¤ï¼‰
- å¦åˆ™åˆ›å»ºæ–°è®°å½•
- æ–°æäº¤çš„å¥åº·è¯åˆå§‹çŠ¶æ€ä¸º `is_current=0`ï¼ˆå¾…å®¡æ ¸ï¼‰ï¼Œå®¡æ ¸é€šè¿‡åè®¾ä¸º `is_current=1`

### 3. å®¡æ ¸é€»è¾‘è°ƒæ•´

**å®¡æ ¸é€šè¿‡æ—¶ï¼š**
- å°†åŒä¸€å‘˜å·¥çš„å…¶ä»–å¥åº·è¯çš„ `is_current` è®¾ä¸º `0`
- å°†å½“å‰å¥åº·è¯çš„ `is_current` è®¾ä¸º `1`
- æ¸…ç©ºæ‹’ç»åŸå› ï¼ˆå¦‚æœä¹‹å‰æœ‰ï¼‰
- **ä¿è¯ï¼šåŒä¸€å‘˜å·¥åªæœ‰ä¸€ä¸ª `is_current=1` çš„å¥åº·è¯**

**å®¡æ ¸æ‹’ç»æ—¶ï¼š**
- è®¾ç½®æ‹’ç»åŸå› 
- `is_current` ä¿æŒä¸å˜ï¼ˆä¸æ”¹å˜ï¼‰

### 4. å‰ç«¯æ˜¾ç¤ºè°ƒæ•´

**ä¿®æ”¹å‰ï¼š**
- åªè¦ `rejectReason` å­—æ®µæœ‰å€¼å°±æ˜¾ç¤ºæ‹’ç»åŸå› 

**ä¿®æ”¹åï¼š**
- åªåœ¨ `status === 'rejected'` æ—¶æ˜¾ç¤ºæ‹’ç»åŸå› 
- å·²é€šè¿‡çš„å¥åº·è¯ä¸æ˜¾ç¤ºæ‹’ç»åŸå› ï¼ˆå³ä½¿å†å²è®°å½•ä¸­æœ‰ï¼‰

## âœ… åŠŸèƒ½éªŒè¯

### ç»Ÿè®¡æŠ¥è¡¨åŠŸèƒ½
- âœ… æ‰€æœ‰ç»Ÿè®¡æŸ¥è¯¢éƒ½ä½¿ç”¨ `is_current=1` æ¡ä»¶
- âœ… ä¸å—ç¼–å·é‡å¤å½±å“ï¼Œç»Ÿè®¡å‡†ç¡®

### åˆ°æœŸæé†’åŠŸèƒ½
- âœ… æé†’æŸ¥è¯¢ä½¿ç”¨ `status='approved' AND is_current=1` æ¡ä»¶
- âœ… ä¸å—ç¼–å·é‡å¤å½±å“ï¼Œæé†’å‡†ç¡®

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šéœ€è¦æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬ç§»é™¤å”¯ä¸€ç´¢å¼•
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šåº”ç”¨å±‚ä¿è¯ `is_current=1` æ—¶ç¼–å·å”¯ä¸€ï¼Œéœ€è¦ç¡®ä¿ä»£ç é€»è¾‘æ­£ç¡®
3. **å†å²æ•°æ®**ï¼šç°æœ‰æ•°æ®ä¸å—å½±å“ï¼Œæ–°æäº¤çš„å¥åº·è¯æŒ‰æ–°é€»è¾‘å¤„ç†

## ğŸ” ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“æ–‡ä»¶
- `health-cert-backend/src/main/resources/sql/schema.sql` - æ›´æ–°è¡¨ç»“æ„æ³¨é‡Š
- `health-cert-backend/src/main/resources/sql/migration_remove_cert_number_unique.sql` - è¿ç§»è„šæœ¬

### åç«¯ä»£ç 
- `health-cert-backend/src/main/java/com/microport/healthcert/service/impl/HealthCertServiceImpl.java` - æäº¤é€»è¾‘
- `health-cert-backend/src/main/java/com/microport/healthcert/service/impl/AdminHealthCertServiceImpl.java` - å®¡æ ¸é€»è¾‘

### å‰ç«¯ä»£ç 
- `health-cert-backend/src/main/resources/static/employee-home.html` - å‘˜å·¥ç«¯è¯¦æƒ…æ˜¾ç¤º
- `health-cert-backend/src/main/resources/static/cert-audit.html` - ç®¡ç†å‘˜ç«¯å®¡æ ¸é¡µé¢ï¼ˆå·²æœ‰æ­£ç¡®é€»è¾‘ï¼‰

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬**
   ```sql
   -- åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ
   source health-cert-backend/src/main/resources/sql/migration_remove_cert_number_unique.sql
   ```

2. **é‡æ–°æ„å»ºå¹¶é‡å¯åç«¯æœåŠ¡**
   ```bash
   docker-compose build backend
   docker-compose restart backend
   ```

3. **éªŒè¯åŠŸèƒ½**
   - æµ‹è¯•æäº¤ç›¸åŒç¼–å·çš„å¥åº·è¯
   - æµ‹è¯•å®¡æ ¸é€šè¿‡æ—¶ `is_current` çš„æ›´æ–°
   - éªŒè¯ç»Ÿè®¡æŠ¥è¡¨å’Œåˆ°æœŸæé†’åŠŸèƒ½æ­£å¸¸

