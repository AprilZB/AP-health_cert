# 架构文档

## 📋 目录

- [系统架构](#系统架构)
- [技术架构](#技术架构)
- [部署架构](#部署架构)
- [数据架构](#数据架构)
- [安全架构](#安全架构)
- [性能优化](#性能优化)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   管理员      │  │    员工      │  │   系统管理员  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      前端展示层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   HTML/CSS   │  │  JavaScript  │  │   Chart.js   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Nginx反向代理                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  静态文件服务  │  API路由  │  负载均衡  │  GZIP压缩  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Spring Boot 应用                         │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │Controller│  │ Service  │  │  Mapper  │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  本地数据库   │  │  远程HR系统  │  │  OCR服务     │
│   MySQL 8.0 │  │  MySQL 8.0   │  │  PaddleOCR   │
└──────────────┘  └──────────────┘  └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   邮件服务   │  │   钉钉服务    │  │   文件存储    │     │
│  │   SMTP      │  │   工作通知    │  │   Docker卷    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 分层架构

#### 1. 表现层（Presentation Layer）

**职责**: 用户界面展示和交互

- **前端页面**: HTML/CSS/JavaScript
- **静态资源**: 图片、样式、脚本文件
- **API调用**: 通过fetch调用后端RESTful API

#### 2. 控制层（Controller Layer）

**职责**: 接收请求、参数验证、响应返回

- **RESTful API**: 统一的接口规范
- **参数验证**: DTO对象验证
- **响应封装**: Result统一响应格式

#### 3. 业务层（Service Layer）

**职责**: 业务逻辑处理

- **业务规则**: 审核流程、同步逻辑等
- **事务管理**: Spring事务管理
- **异常处理**: 业务异常抛出

#### 4. 数据访问层（Data Access Layer）

**职责**: 数据库操作

- **MyBatis-Plus**: ORM框架
- **SQL映射**: XML或注解方式
- **分页支持**: PageHelper分页

#### 5. 数据层（Data Layer）

**职责**: 数据存储

- **MySQL**: 主数据库
- **远程数据库**: HR系统数据库（只读）
- **文件存储**: Docker卷存储上传文件

---

## 技术架构

### 后端架构

```
Spring Boot Application
├── Web层
│   ├── Controller (RESTful API)
│   ├── Interceptor (JWT验证、日志记录)
│   └── Exception Handler (全局异常处理)
├── Service层
│   ├── Service Interface
│   └── Service Implementation
├── Data层
│   ├── Mapper (MyBatis-Plus)
│   ├── Entity (实体类)
│   └── DTO/VO (数据传输对象)
├── Config层
│   ├── DataSource Config (数据源配置)
│   ├── MyBatis Config (MyBatis配置)
│   └── Web Config (Web配置)
└── Util层
    ├── JWT工具
    ├── 文件工具
    └── 通用工具
```

### 前端架构

```
前端应用
├── 页面层
│   ├── 登录页
│   ├── 员工端页面
│   └── 管理员端页面
├── 公共层
│   ├── api.js (API封装)
│   └── common.js (工具函数)
└── 资源层
    ├── 图片资源
    ├── 样式文件
    └── 第三方库
```

---

## 部署架构

### Docker容器架构

```
Docker Compose
├── MySQL容器
│   ├── 数据卷: mysql_data
│   ├── 端口映射: 3306:3306
│   └── 健康检查: mysqladmin ping
├── Backend容器
│   ├── 数据卷: uploads, downloads, backups
│   ├── 端口映射: 8080:8080
│   ├── 依赖: MySQL健康检查通过
│   └── 健康检查: /api/auth/health
└── Nginx容器
    ├── 静态文件卷: static files
    ├── 端口映射: 80:80
    ├── 依赖: Backend健康检查通过
    └── 配置: nginx.conf
```

### 网络架构

```
外部网络
    │
    ▼
Nginx (80端口)
    │
    ├──→ 静态文件 (直接服务)
    │
    └──→ API请求 (/api/*)
            │
            ▼
        Backend (8080端口)
            │
            ├──→ 本地MySQL (3306端口)
            │
            └──→ 远程HR数据库 (只读)
```

---

## 数据架构

### 数据流架构

```
数据输入
    │
    ├──→ 员工上传健康证
    │       │
    │       ├──→ OCR识别
    │       │
    │       └──→ 数据库存储
    │
    └──→ HR系统同步
            │
            ├──→ 员工数据同步
            │
            └──→ 部门数据同步
                    │
                    └──→ 数据库更新
```

### 数据存储架构

```
数据存储
├── 关系型数据 (MySQL)
│   ├── 员工信息
│   ├── 健康证信息
│   ├── 部门信息
│   └── 系统配置
├── 文件存储 (Docker卷)
│   ├── 健康证图片 (/app/uploads)
│   ├── 导出文件 (/app/downloads)
│   └── 备份文件 (/app/backups)
└── 缓存 (内存)
    ├── JWT Token缓存
    └── 钉钉Token缓存
```

### 数据同步架构

```
定时任务
    │
    ├──→ 员工同步任务 (每天凌晨2点)
    │       │
    │       └──→ 从远程HR数据库同步
    │
    └──→ 提醒任务 (每天上午9点)
            │
            ├──→ 查询即将到期健康证
            │
            └──→ 发送邮件/钉钉提醒
```

---

## 安全架构

### 认证授权架构

```
用户请求
    │
    ▼
JWT拦截器
    │
    ├──→ 验证Token有效性
    │
    ├──→ 提取用户信息
    │
    └──→ 设置请求上下文
            │
            ▼
        业务处理
```

### 安全措施

1. **身份认证**
   - JWT Token认证
   - Token过期时间：24小时
   - 密码加密：BCrypt

2. **权限控制**
   - 基于角色的访问控制（RBAC）
   - 接口级别的权限验证
   - 管理员/员工角色分离

3. **数据安全**
   - SQL注入防护：MyBatis参数化查询
   - XSS防护：前端输入验证
   - CSRF防护：Token验证

4. **传输安全**
   - HTTPS支持（生产环境）
   - 敏感信息加密传输

---

## 性能优化

### 数据库优化

1. **索引优化**
   - 主键索引
   - 唯一索引（健康证编号、用户名等）
   - 复合索引（查询频繁的字段组合）

2. **查询优化**
   - 分页查询（避免全表扫描）
   - 只查询必要字段
   - 使用MyBatis-Plus的批量操作

3. **连接池优化**
   - HikariCP连接池
   - 合理设置连接池大小

### 应用优化

1. **缓存策略**
   - JWT Token缓存（减少数据库查询）
   - 钉钉Token缓存（2小时有效期）
   - 配置信息缓存（减少数据库查询）

2. **异步处理**
   - OCR识别异步处理（可选）
   - 邮件发送异步处理
   - 日志记录异步处理

3. **文件处理**
   - 图片压缩（上传时）
   - 文件分片上传（大文件）
   - CDN加速（生产环境）

### 前端优化

1. **资源优化**
   - 静态资源压缩（GZIP）
   - 图片懒加载
   - 代码压缩和混淆

2. **请求优化**
   - API请求合并
   - 防抖和节流
   - 本地缓存（LocalStorage）

---

## 扩展性设计

### 水平扩展

- **无状态设计**: 后端服务无状态，可水平扩展
- **负载均衡**: Nginx支持多实例负载均衡
- **数据库读写分离**: 支持主从复制

### 垂直扩展

- **资源调整**: Docker容器资源可调整
- **JVM参数**: 可根据服务器配置调整

### 功能扩展

- **插件化设计**: 服务接口化，易于扩展
- **配置化**: 系统配置存储在数据库，无需重启
- **模块化**: 功能模块独立，易于维护

---

**最后更新**: 2024年12月

