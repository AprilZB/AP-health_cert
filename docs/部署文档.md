# éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [éƒ¨ç½²æ–¹å¼](#éƒ¨ç½²æ–¹å¼)
- [Dockeréƒ¨ç½²](#dockeréƒ¨ç½²)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [æœåŠ¡å¯åŠ¨](#æœåŠ¡å¯åŠ¨)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [æ•°æ®å¤‡ä»½](#æ•°æ®å¤‡ä»½)
- [ç›‘æ§è¿ç»´](#ç›‘æ§è¿ç»´)

---

## éƒ¨ç½²æ–¹å¼

### æ¨èéƒ¨ç½²æ–¹å¼ï¼šDocker Compose

æœ¬é¡¹ç›®é‡‡ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²ï¼Œä½¿ç”¨Docker Composeè¿›è¡ŒæœåŠ¡ç¼–æ’ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- âœ… **ä¸€é”®éƒ¨ç½²**: å•ä¸ªå‘½ä»¤å¯åŠ¨æ‰€æœ‰æœåŠ¡
- âœ… **ç¯å¢ƒéš”ç¦»**: å„æœåŠ¡ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
- âœ… **æ˜“äºç»´æŠ¤**: ç»Ÿä¸€çš„æ—¥å¿—ã€é…ç½®ç®¡ç†
- âœ… **å¿«é€Ÿæ‰©å±•**: æ”¯æŒæ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡

### å…¶ä»–éƒ¨ç½²æ–¹å¼

- **ä¼ ç»Ÿéƒ¨ç½²**: éœ€è¦æ‰‹åŠ¨å®‰è£…JDKã€MySQLã€Nginxç­‰ï¼ˆä¸æ¨èï¼‰
- **Kuberneteséƒ¨ç½²**: é€‚åˆå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒï¼ˆæœªæ¥æ”¯æŒï¼‰

---

## Dockeréƒ¨ç½²

### å‰ç½®æ¡ä»¶

1. **å®‰è£…Docker**
   ```bash
   # æ£€æŸ¥Dockerç‰ˆæœ¬
   docker --version
   # éœ€è¦ Docker 20.10 æˆ–æ›´é«˜ç‰ˆæœ¬
   ```

2. **å®‰è£…Docker Compose**
   ```bash
   # æ£€æŸ¥Docker Composeç‰ˆæœ¬
   docker-compose --version
   # éœ€è¦ Docker Compose 1.29 æˆ–æ›´é«˜ç‰ˆæœ¬
   ```

3. **ç³»ç»Ÿèµ„æºè¦æ±‚**
   - CPU: 2æ ¸å¿ƒæˆ–ä»¥ä¸Š
   - å†…å­˜: 4GBæˆ–ä»¥ä¸Šï¼ˆæ¨è8GBï¼‰
   - ç£ç›˜: è‡³å°‘10GBå¯ç”¨ç©ºé—´

### å¿«é€Ÿéƒ¨ç½²

#### æ­¥éª¤1ï¼šå…‹éš†é¡¹ç›®

```bash
git clone https://github.com/AprilZB/AP-health_cert.git
cd health-cert-system
```

#### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

åˆ›å»º`.env`æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å¯è·³è¿‡ï¼‰ï¼š

```bash
# MySQLé…ç½®
MYSQL_ROOT_PASSWORD=root123
MYSQL_DATABASE=health_cert_db

# åç«¯æœåŠ¡é…ç½®
SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/health_cert_db?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
SPRING_DATASOURCE_USERNAME=root
SPRING_DATASOURCE_PASSWORD=root123

# JVMå‚æ•°
JAVA_OPTS=-Xms512m -Xmx1024m -Dfile.encoding=UTF-8
```

#### æ­¥éª¤3ï¼šå¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f
```

#### æ­¥éª¤4ï¼šç­‰å¾…æœåŠ¡å¯åŠ¨

é¦–æ¬¡å¯åŠ¨éœ€è¦ï¼š
- ä¸‹è½½Dockeré•œåƒï¼ˆçº¦5-10åˆ†é’Ÿï¼‰
- æ„å»ºåç«¯é•œåƒï¼ˆçº¦3-5åˆ†é’Ÿï¼‰
- åˆå§‹åŒ–æ•°æ®åº“ï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

**æ€»è€—æ—¶çº¦10-20åˆ†é’Ÿ**ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚

#### æ­¥éª¤5ï¼šéªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# åº”è¯¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½åœ¨è¿è¡Œï¼š
# - health-cert-mysql (Up, healthy)
# - health-cert-backend (Up, healthy)
# - health-cert-nginx (Up)
```

è®¿é—®ç³»ç»Ÿï¼š
- ç³»ç»Ÿé¦–é¡µ: http://localhost
- ç™»å½•é¡µé¢: http://localhost/login.html

é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼š
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123`

---

## ç¯å¢ƒé…ç½®

### Docker Composeé…ç½®

ä¸»è¦é…ç½®æ–‡ä»¶ï¼š`docker-compose.yml`

#### MySQLæœåŠ¡é…ç½®

```yaml
mysql:
  image: mysql:8.0
  environment:
    MYSQL_ROOT_PASSWORD: root123
    MYSQL_DATABASE: health_cert_db
    MYSQL_CHARACTER_SET_SERVER: utf8mb4
    MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
  ports:
    - "3306:3306"
  volumes:
    - mysql_data:/var/lib/mysql
    - ./health-cert-backend/src/main/resources/sql:/docker-entrypoint-initdb.d
```

#### åç«¯æœåŠ¡é…ç½®

```yaml
backend:
  build:
    context: ./health-cert-backend
    dockerfile: Dockerfile
  environment:
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/health_cert_db?...
    SPRING_DATASOURCE_USERNAME: root
    SPRING_DATASOURCE_PASSWORD: root123
    JAVA_OPTS: "-Xms512m -Xmx1024m -Dfile.encoding=UTF-8"
  ports:
    - "8080:8080"
  volumes:
    - uploads:/app/uploads
    - downloads:/app/downloads
    - backups:/app/backups
```

#### NginxæœåŠ¡é…ç½®

```yaml
nginx:
  image: nginx:1.24-alpine
  ports:
    - "80:80"
  volumes:
    - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    - ./health-cert-backend/src/main/resources/static:/usr/share/nginx/html/static:ro
    - uploads:/usr/share/nginx/html/uploads:ro
```

### åº”ç”¨é…ç½®

ä¸»è¦é…ç½®æ–‡ä»¶ï¼š`health-cert-backend/src/main/resources/application.yml`

#### æ•°æ®æºé…ç½®

```yaml
spring:
  datasource:
    # æœ¬åœ°æ•°æ®åº“ï¼ˆä¸»æ•°æ®æºï¼‰
    url: jdbc:mysql://mysql:3306/health_cert_db?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
    username: root
    password: root123
    driver-class-name: com.mysql.cj.jdbc.Driver
```

#### OCRæœåŠ¡é…ç½®

```yaml
ocr:
  service:
    url: http://10.11.100.238:8081/ocr
    timeout: 30000
```

#### JWTé…ç½®

```yaml
jwt:
  secret: microport-health-cert-secret-2024
  expiration: 86400000  # 24å°æ—¶
```

---

## æœåŠ¡å¯åŠ¨

### å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# åå°å¯åŠ¨
docker-compose up -d

# å‰å°å¯åŠ¨ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
docker-compose up
```

### å¯åŠ¨æŒ‡å®šæœåŠ¡

```bash
# åªå¯åŠ¨MySQL
docker-compose up -d mysql

# å¯åŠ¨MySQLå’Œåç«¯
docker-compose up -d mysql backend

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d
```

### å¯åŠ¨é¡ºåº

æœåŠ¡å¯åŠ¨æœ‰ä¾èµ–å…³ç³»ï¼ŒDocker Composeä¼šè‡ªåŠ¨å¤„ç†ï¼š

1. **MySQL** â†’ é¦–å…ˆå¯åŠ¨ï¼Œç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
2. **Backend** â†’ ç­‰å¾…MySQLå¥åº·æ£€æŸ¥é€šè¿‡åå¯åŠ¨
3. **Nginx** â†’ ç­‰å¾…Backendå¥åº·æ£€æŸ¥é€šè¿‡åå¯åŠ¨

---

## æœåŠ¡ç®¡ç†

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æœåŠ¡èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs -f
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯æŒ‡å®šæœåŠ¡
docker-compose restart backend
docker-compose restart mysql
docker-compose restart nginx
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®å·ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
docker-compose down -v
```

### æ›´æ–°æœåŠ¡

```bash
# é‡æ–°æ„å»ºåç«¯é•œåƒï¼ˆä»£ç æ›´æ–°åï¼‰
docker-compose build backend

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build backend

# æ›´æ–°æ‰€æœ‰æœåŠ¡
docker-compose pull  # æ‹‰å–æœ€æ–°é•œåƒ
docker-compose up -d --build  # é‡æ–°æ„å»ºå¹¶å¯åŠ¨
```

---

## æ•°æ®å¤‡ä»½

### æ•°æ®åº“å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“
docker-compose exec mysql mysqldump -uroot -proot123 health_cert_db > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½åˆ°æŒ‡å®šç›®å½•
docker-compose exec mysql mysqldump -uroot -proot123 health_cert_db > /app/backups/backup_$(date +%Y%m%d_%H%M%S).sql
```

### æ•°æ®åº“æ¢å¤

```bash
# æ¢å¤æ•°æ®åº“
docker-compose exec -T mysql mysql -uroot -proot123 health_cert_db < backup.sql

# ä»æ–‡ä»¶æ¢å¤
cat backup.sql | docker-compose exec -T mysql mysql -uroot -proot123 health_cert_db
```

### æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
docker cp health-cert-backend:/app/uploads ./backups/uploads_$(date +%Y%m%d)

# å¤‡ä»½å¯¼å‡ºæ–‡ä»¶
docker cp health-cert-backend:/app/downloads ./backups/downloads_$(date +%Y%m%d)
```

### å®Œæ•´å¤‡ä»½è„šæœ¬

åˆ›å»ºå¤‡ä»½è„šæœ¬ `backup.sh`:

```bash
#!/bin/bash
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
docker-compose exec -T mysql mysqldump -uroot -proot123 health_cert_db > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½æ–‡ä»¶
docker cp health-cert-backend:/app/uploads $BACKUP_DIR/uploads_$DATE
docker cp health-cert-backend:/app/downloads $BACKUP_DIR/downloads_$DATE

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

---

## ç›‘æ§è¿ç»´

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f mysql
docker-compose logs -f nginx

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose logs --tail=100 backend

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose logs backend | grep -i error
```

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥åç«¯æœåŠ¡å¥åº·
curl http://localhost:8080/api/auth/health

# æ£€æŸ¥MySQLè¿æ¥
docker-compose exec mysql mysqladmin ping -h localhost -uroot -proot123

# æ£€æŸ¥NginxçŠ¶æ€
curl http://localhost
```

### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect health-cert-backend

# æŸ¥çœ‹å®¹å™¨è¿›ç¨‹
docker-compose exec backend ps aux
```

### æ•…éšœæ’æŸ¥

#### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# 1. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs backend

# 2. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tuln | grep -E '80|8080|3306'

# 3. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 4. æ£€æŸ¥DockeræœåŠ¡
docker info
```

#### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# 1. æ£€æŸ¥MySQLæœåŠ¡
docker-compose ps mysql

# 2. æµ‹è¯•MySQLè¿æ¥
docker-compose exec mysql mysql -uroot -proot123 -e "SELECT 1"

# 3. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
docker-compose exec mysql mysql -uroot -proot123 -e "SHOW DATABASES;"
```

#### åº”ç”¨è®¿é—®å¼‚å¸¸

```bash
# 1. æ£€æŸ¥Nginxé…ç½®
docker-compose exec nginx nginx -t

# 2. æ£€æŸ¥åç«¯æœåŠ¡
docker-compose ps backend

# 3. æµ‹è¯•APIæ¥å£
curl http://localhost/api/auth/health
```

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®

### å®‰å…¨é…ç½®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **
   - MySQL rootå¯†ç 
   - ç®¡ç†å‘˜è´¦å·å¯†ç 

2. **HTTPSé…ç½®**
   - é…ç½®SSLè¯ä¹¦
   - ä¿®æ”¹Nginxé…ç½®æ”¯æŒHTTPS

3. **é˜²ç«å¢™é…ç½®**
   - åªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80/443ï¼‰
   - å…³é—­3306å’Œ8080ç«¯å£ï¼ˆä»…å†…ç½‘è®¿é—®ï¼‰

### æ€§èƒ½ä¼˜åŒ–

1. **èµ„æºé™åˆ¶**
   ```yaml
   # docker-compose.yml
   backend:
     deploy:
       resources:
         limits:
           cpus: '2'
           memory: 2G
   ```

2. **æ•°æ®åº“ä¼˜åŒ–**
   - è°ƒæ•´MySQLé…ç½®å‚æ•°
   - å¯ç”¨æŸ¥è¯¢ç¼“å­˜
   - ä¼˜åŒ–ç´¢å¼•

3. **Nginxä¼˜åŒ–**
   - å¯ç”¨GZIPå‹ç¼©
   - é…ç½®ç¼“å­˜ç­–ç•¥
   - é™åˆ¶è¯·æ±‚å¤§å°

### é«˜å¯ç”¨éƒ¨ç½²

1. **è´Ÿè½½å‡è¡¡**
   - éƒ¨ç½²å¤šä¸ªåç«¯å®ä¾‹
   - Nginxè´Ÿè½½å‡è¡¡é…ç½®

2. **æ•°æ®åº“ä¸»ä»**
   - MySQLä¸»ä»å¤åˆ¶
   - è¯»å†™åˆ†ç¦»

3. **æ•°æ®å¤‡ä»½**
   - å®šæ—¶è‡ªåŠ¨å¤‡ä»½
   - å¼‚åœ°å¤‡ä»½å­˜å‚¨

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ26æ—¥

