# 邮件发送问题排查指南

## 🔍 问题现象

测试邮件显示"发送成功"，但实际邮箱未收到邮件。

## 🛠️ 已修复的问题

### 1. 异常处理问题
**问题**：`sendEmail` 方法在发送失败时不抛异常，导致测试邮件误报成功。

**修复**：
- `sendEmail` 方法现在会抛出异常（用于测试）
- 新增 `sendEmailSilently` 方法（用于定时任务，失败不抛异常）
- 测试邮件会显示真实的错误信息

### 2. SMTP配置优化
**问题**：SMTP配置固定，不支持TLS/SSL。

**修复**：
- 根据端口自动启用TLS/SSL：
  - 端口 465：启用 SSL
  - 端口 587/25：启用 TLS
  - 其他端口：不启用加密
- 添加详细的日志输出

## 📋 排查步骤

### 步骤1：检查后端日志

查看后端服务的日志，查找邮件发送相关的错误信息：

```bash
# 查看后端日志
docker-compose logs -f backend | grep -i "mail\|email\|smtp"
```

### 步骤2：检查SMTP配置

在系统配置页面检查以下配置项：

1. **SMTP服务器地址** (`email.smtp.host`)
   - 常见值：`smtp.office365.com`、`smtp.gmail.com`、`smtp.qq.com`、`smtp.exmail.qq.com`

2. **SMTP端口** (`email.smtp.port`)
   - 常见值：`587`（TLS）、`465`（SSL）、`25`（不加密）

3. **用户名** (`email.username`)
   - 通常是完整的邮箱地址

4. **密码** (`email.password`)
   - 可能是邮箱密码或应用专用密码

5. **发件人邮箱** (`email.from`)
   - 必须与用户名一致或为授权发件人

### 步骤3：常见问题

#### 问题1：端口和加密方式不匹配
**症状**：连接超时或认证失败

**解决方案**：
- 端口 465 → 启用 SSL
- 端口 587 → 启用 TLS
- 端口 25 → 不启用加密

#### 问题2：需要应用专用密码
**症状**：认证失败（如 Gmail、QQ邮箱）

**解决方案**：
- Gmail：需要在Google账号中启用"应用专用密码"
- QQ邮箱：需要在QQ邮箱设置中开启SMTP服务并获取授权码

#### 问题3：发件人邮箱与用户名不一致
**症状**：发送失败或邮件被拒绝

**解决方案**：
- 确保 `email.from` 与 `email.username` 一致
- 或确保 `email.from` 是授权发件人

#### 问题4：邮件被拦截或进入垃圾箱
**症状**：发送成功但收不到邮件

**解决方案**：
- 检查垃圾邮件文件夹
- 检查邮件服务器的拦截规则
- 检查发件人域名是否被拉黑

### 步骤4：测试邮件配置

1. **在系统配置页面点击"测试邮件"**
2. **查看返回的错误信息**（现在会显示真实错误）
3. **根据错误信息调整配置**

### 步骤5：查看详细日志

如果问题仍然存在，可以启用更详细的日志：

1. 查看后端日志中的SMTP连接信息
2. 检查是否有认证错误
3. 检查是否有连接超时

## 🔧 常见SMTP服务器配置

### Office 365 / Outlook
```
SMTP服务器：smtp.office365.com
端口：587
加密：TLS
用户名：完整邮箱地址
密码：邮箱密码或应用密码
```

### Gmail
```
SMTP服务器：smtp.gmail.com
端口：587（TLS）或 465（SSL）
加密：TLS 或 SSL
用户名：完整邮箱地址
密码：应用专用密码（不是邮箱密码）
```

### QQ邮箱
```
SMTP服务器：smtp.qq.com
端口：587（TLS）或 465（SSL）
加密：TLS 或 SSL
用户名：QQ号@qq.com
密码：授权码（不是QQ密码）
```

### 企业邮箱（腾讯企业邮箱）
```
SMTP服务器：smtp.exmail.qq.com
端口：587（TLS）或 465（SSL）
加密：TLS 或 SSL
用户名：完整邮箱地址
密码：邮箱密码或授权码
```

## 📝 日志示例

### 成功发送的日志
```
创建邮件发送器：host=smtp.office365.com, port=587, username=xxx@example.com, from=xxx@example.com
邮件发送成功：收件人=Bo.Zhang@accupathmed.com, 主题=健康证系统测试邮件, 发件人=xxx@example.com
```

### 失败的日志
```
邮件发送失败：收件人=Bo.Zhang@accupathmed.com, 主题=健康证系统测试邮件, 发件人=xxx@example.com, 错误=Authentication failed
```

## 🚀 下一步

1. **重启后端服务**使新代码生效
2. **重新测试邮件发送**
3. **查看详细的错误信息**
4. **根据错误信息调整SMTP配置**

