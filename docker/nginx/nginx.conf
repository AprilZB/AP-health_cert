# 员工健康证管理系统 - Nginx配置文件
# 反向代理后端API，托管静态文件

# 定义工作进程数（auto表示自动检测CPU核心数）
worker_processes auto;

# 错误日志位置和级别
error_log /var/log/nginx/error.log warn;

# PID文件位置
pid /var/run/nginx.pid;

# 事件模块配置
events {
    # 每个工作进程的最大连接数
    worker_connections 1024;
    # 使用epoll事件模型（Linux高效I/O模型）
    use epoll;
}

# HTTP服务器配置
http {
    # 包含MIME类型定义
    include /etc/nginx/mime.types;
    # 默认MIME类型
    default_type application/octet-stream;

    # 日志格式定义
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # 访问日志位置和格式
    access_log /var/log/nginx/access.log main;

    # 基本性能优化配置
    # 启用sendfile，提高文件传输效率
    sendfile on;
    # 禁用TCP_NOPUSH，提高网络效率
    tcp_nopush on;
    # 启用TCP_NODELAY，减少延迟
    tcp_nodelay on;
    # 保持连接超时时间
    keepalive_timeout 65;
    # 隐藏Nginx版本号（安全考虑）
    server_tokens off;

    # ==================== GZIP压缩配置 ====================
    # 启用GZIP压缩，减少传输数据量，提高页面加载速度
    gzip on;
    # GZIP压缩级别（1-9，级别越高压缩率越高但CPU消耗越大，6是平衡点）
    gzip_comp_level 6;
    # 最小压缩文件大小（小于1字节的文件不压缩）
    gzip_min_length 1;
    # GZIP压缩的MIME类型
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    # 禁用对IE6的GZIP压缩（IE6不支持）
    gzip_disable "msie6";
    # 启用Vary头，支持代理缓存
    gzip_vary on;

    # ==================== 上游服务器配置 ====================
    # 定义后端服务（backend是docker-compose.yml中定义的服务名）
    upstream backend {
        # 后端服务地址和端口
        server backend:8080;
        # 保持连接池大小
        keepalive 32;
    }

    # ==================== HTTP服务器配置 ====================
    server {
        # 监听端口
        listen 80;
        # 服务器名称（可以配置域名）
        server_name localhost;

        # 客户端请求体最大大小（用于文件上传）
        client_max_body_size 20M;

        # 字符集设置
        charset utf-8;

        # ==================== API请求代理 ====================
        # 所有/api开头的请求代理到后端服务
        location /api {
            # 代理到上游服务器
            proxy_pass http://backend;
            # 设置代理请求头
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # 代理超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            # 禁用缓冲，实时传输
            proxy_buffering off;
        }

        # ==================== 上传文件访问 ====================
        # 访问上传的健康证图片
        # 代理到后端Spring Boot服务（因为文件存储在后端容器中）
        # 使用 ^~ 前缀匹配，确保优先级高于正则匹配规则
        location ^~ /uploads {
            # 代理到后端服务
            proxy_pass http://backend;
            # 设置代理请求头
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # 代理超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            # 禁用缓冲，实时传输
            proxy_buffering off;
            # 设置缓存时间（图片文件缓存1天）
            expires 1d;
            # 添加CORS头（如果需要跨域访问）
            add_header Access-Control-Allow-Origin *;
        }

        # ==================== 下载文件访问 ====================
        # 访问导出的Excel/PDF文件
        location /downloads {
            # 文件根目录
            alias /usr/share/nginx/html/downloads;
            # 启用目录列表（可选，生产环境建议关闭）
            autoindex off;
            # 不缓存下载文件（确保获取最新文件）
            expires -1;
            # 添加CORS头（如果需要跨域访问）
            add_header Access-Control-Allow-Origin *;
        }

        # ==================== 静态文件托管 ====================
        # 托管前端静态文件（HTML、CSS、JS等）
        location / {
            # 静态文件根目录
            root /usr/share/nginx/html/static;
            # 默认首页文件（优先查找login.html）
            index login.html index.html;
            # 尝试按顺序查找文件
            try_files $uri $uri/ /login.html;
        }

        # ==================== 静态资源缓存 ====================
        # CSS和JS文件缓存配置
        location ~* \.(css|js)$ {
            root /usr/share/nginx/html/static;
            # 缓存30天
            expires 30d;
            # 添加缓存控制头
            add_header Cache-Control "public, immutable";
        }

        # 图片文件缓存配置
        location ~* \.(jpg|jpeg|png|gif|ico|svg)$ {
            root /usr/share/nginx/html/static;
            # 缓存7天
            expires 7d;
            # 添加缓存控制头
            add_header Cache-Control "public";
        }

        # ==================== 错误页面 ====================
        # 404错误页面
        error_page 404 /404.html;
        location = /404.html {
            root /usr/share/nginx/html/static;
        }

        # 50x错误页面
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html/static;
        }
    }
}

