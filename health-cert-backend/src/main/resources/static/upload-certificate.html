<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥å¥åº·è¯ç®¡ç†ç³»ç»Ÿ - ä¸Šä¼ å¥åº·è¯</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        /* å®¹å™¨ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }

        /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0ff;
        }

        .upload-area.has-image {
            border: none;
            padding: 0;
            background: transparent;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        .uploaded-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .image-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .image-action-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-action-btn:hover {
            background: #f5f5f5;
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        #fileInput {
            display: none;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: #f00;
            margin-left: 3px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* æäº¤æŒ‰é’® */
        .submit-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-group input,
            .form-group select {
                padding: 14px; /* ç§»åŠ¨ç«¯å¢å¤§ç‚¹å‡»åŒºåŸŸ */
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
            }

            .submit-button {
                padding: 16px; /* ç§»åŠ¨ç«¯å¤§æŒ‰é’® */
                font-size: 16px;
            }

            .upload-area {
                padding: 30px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
        <h1>ä¸Šä¼ å¥åº·è¯</h1>
    </div>

    <div class="container">
        <!-- é”™è¯¯æç¤º -->
        <div class="error-message" id="errorMessage"></div>

        <!-- æˆåŠŸæç¤º -->
        <div class="success-message" id="successMessage"></div>

        <!-- å›¾ç‰‡ä¸Šä¼ å¡ç‰‡ -->
        <div class="card">
            <h2>ä¸Šä¼ å¥åº·è¯å›¾ç‰‡</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€BMP æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB</div>
                <div class="upload-hint" style="margin-top: 5px;">ç§»åŠ¨ç«¯æ”¯æŒæ‹ç…§ä¸Šä¼ </div>
            </div>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/bmp" capture="environment">
        </div>

        <!-- å¥åº·è¯ä¿¡æ¯è¡¨å• -->
        <div class="card">
            <h2>å¥åº·è¯ä¿¡æ¯</h2>
            <form id="certificateForm">
                <!-- ç¬¬ä¸€è¡Œï¼šç¼–å·ã€å§“å -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="certNumber">å¥åº·è¯ç¼–å· <span class="required">*</span></label>
                        <input type="text" id="certNumber" name="certNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="employeeName">å§“å <span class="required">*</span></label>
                        <input type="text" id="employeeName" name="employeeName" required>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šæ€§åˆ«ã€å¹´é¾„ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">æ€§åˆ«</label>
                        <select id="gender" name="gender">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="age">å¹´é¾„</label>
                        <input type="number" id="age" name="age" min="1" max="150">
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šèº«ä»½è¯å·ã€ç±»åˆ« -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="idCard">èº«ä»½è¯å·</label>
                        <input type="text" id="idCard" name="idCard" maxlength="18">
                    </div>
                    <div class="form-group">
                        <label for="category">å¥åº·è¯ç±»åˆ«</label>
                        <input type="text" id="category" name="category">
                    </div>
                </div>

                <!-- ç¬¬å››è¡Œï¼šå‘è¯æ—¥æœŸã€æœ‰æ•ˆæœŸè‡³ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueDate">å‘è¯æ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="issueDate" name="issueDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">æœ‰æ•ˆæœŸè‡³ <span class="required">*</span></label>
                        <input type="date" id="expiryDate" name="expiryDate" required>
                    </div>
                </div>

                <!-- å‘è¯æœºæ„ -->
                <div class="form-group">
                    <label for="issuingAuthority">å‘è¯æœºæ„</label>
                    <input type="text" id="issuingAuthority" name="issuingAuthority">
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" class="submit-button" id="submitButton">
                    æäº¤å®¡æ ¸
                </button>
            </form>
        </div>
    </div>

    <script>
        // APIåŸºç¡€åœ°å€
        const API_BASE_URL = '/api';

        // è·å–DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const certificateForm = document.getElementById('certificateForm');
        const submitButton = document.getElementById('submitButton');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // å½“å‰ä¸Šä¼ çš„å›¾ç‰‡
        let currentImageFile = null;
        let currentImagePath = null;

        /**
         * è·å–Token
         */
        function getToken() {
            return localStorage.getItem('token');
        }

        /**
         * æ£€æŸ¥ç™»å½•çŠ¶æ€
         */
        function checkLogin() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
         */
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
        }

        /**
         * éšè—æ¶ˆæ¯
         */
        function hideMessages() {
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
        }

        /**
         * è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
         */
        function setButtonLoading(loading) {
            if (loading) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="loading"></span>æäº¤ä¸­...';
            } else {
                submitButton.disabled = false;
                submitButton.textContent = 'æäº¤å®¡æ ¸';
            }
        }

        /**
         * éªŒè¯å›¾ç‰‡æ–‡ä»¶
         */
        function validateImage(file) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/png', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                showError('åªæ”¯æŒ JPGã€PNGã€BMP æ ¼å¼çš„å›¾ç‰‡');
                return false;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return false;
            }

            return true;
        }

        /**
         * æ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡
         */
        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadArea.classList.add('has-image');
                uploadArea.innerHTML = `
                    <img src="${e.target.result}" alt="å¥åº·è¯å›¾ç‰‡" class="uploaded-image" id="uploadedImage">
                    <div class="image-actions">
                        <button type="button" class="image-action-btn" onclick="removeImage()">é‡æ–°é€‰æ‹©</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        /**
         * ç§»é™¤å›¾ç‰‡
         */
        function removeImage() {
            currentImageFile = null;
            currentImagePath = null;
            uploadArea.classList.remove('has-image');
            uploadArea.innerHTML = `
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€BMP æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB</div>
                <div class="upload-hint" style="margin-top: 5px;">ç§»åŠ¨ç«¯æ”¯æŒæ‹ç…§ä¸Šä¼ </div>
            `;
            fileInput.value = '';
        }

        /**
         * å¤„ç†æ–‡ä»¶é€‰æ‹©
         */
        function handleFileSelect(file) {
            if (!validateImage(file)) {
                return;
            }

            currentImageFile = file;
            displayImage(file);

            // è‡ªåŠ¨ä¸Šä¼ å¹¶è°ƒç”¨OCR
            uploadAndOcr(file);
        }

        /**
         * ä¸Šä¼ å›¾ç‰‡å¹¶è°ƒç”¨OCRè¯†åˆ«
         */
        async function uploadAndOcr(file) {
            hideMessages();
            setButtonLoading(true);

            try {
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('image', file);

                // å‘é€ä¸Šä¼ è¯·æ±‚
                const response = await fetch(API_BASE_URL + '/health-cert/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    const data = result.data || {};
                    
                    // è°ƒè¯•ï¼šæ‰“å°OCRè¿”å›çš„æ•°æ®
                    console.log('OCRè¿”å›æ•°æ®:', data);
                    
                    // ä¿å­˜å›¾ç‰‡è·¯å¾„
                    currentImagePath = data.imagePath;

                    // è‡ªåŠ¨å¡«å……è¡¨å•å­—æ®µï¼ˆå¦‚æœOCRè¯†åˆ«æˆåŠŸï¼‰
                    let filledCount = 0;
                    
                    if (data.certNumber) {
                        document.getElementById('certNumber').value = data.certNumber;
                        filledCount++;
                    }
                    if (data.employeeName) {
                        document.getElementById('employeeName').value = data.employeeName;
                        filledCount++;
                    }
                    if (data.gender) {
                        document.getElementById('gender').value = data.gender;
                        filledCount++;
                    }
                    if (data.age) {
                        document.getElementById('age').value = data.age;
                        filledCount++;
                    }
                    if (data.idCard) {
                        document.getElementById('idCard').value = data.idCard;
                        filledCount++;
                    }
                    if (data.category) {
                        document.getElementById('category').value = data.category;
                        filledCount++;
                    }
                    if (data.issueDate) {
                        // å¤„ç†æ—¥æœŸæ ¼å¼ï¼ˆåç«¯è¿”å›çš„æ˜¯"YYYY-MM-DD"æ ¼å¼ï¼‰
                        const issueDateStr = typeof data.issueDate === 'string' 
                            ? data.issueDate 
                            : data.issueDate.split('T')[0]; // å¤„ç†ISOæ ¼å¼
                        document.getElementById('issueDate').value = issueDateStr;
                        filledCount++;
                    }
                    if (data.expiryDate) {
                        // å¤„ç†æ—¥æœŸæ ¼å¼ï¼ˆåç«¯è¿”å›çš„æ˜¯"YYYY-MM-DD"æ ¼å¼ï¼‰
                        const expiryDateStr = typeof data.expiryDate === 'string' 
                            ? data.expiryDate 
                            : data.expiryDate.split('T')[0]; // å¤„ç†ISOæ ¼å¼
                        document.getElementById('expiryDate').value = expiryDateStr;
                        filledCount++;
                    }
                    if (data.issuingAuthority) {
                        document.getElementById('issuingAuthority').value = data.issuingAuthority;
                        filledCount++;
                    }

                    console.log('OCRè¯†åˆ«æˆåŠŸï¼Œå¡«å……äº† ' + filledCount + ' ä¸ªå­—æ®µ');
                    
                    if (filledCount > 0) {
                        showSuccess('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒOCRè¯†åˆ«å®Œæˆï¼ˆå·²å¡«å……' + filledCount + 'ä¸ªå­—æ®µï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰');
                    } else {
                        showSuccess('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä½†OCRè¯†åˆ«æœªæå–åˆ°ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨å¡«å†™');
                    }
                } else {
                    // OCRè¯†åˆ«å¤±è´¥ï¼Œå…è®¸æ‰‹åŠ¨å¡«å†™
                    if (result.data && result.data.imagePath) {
                        currentImagePath = result.data.imagePath;
                        showSuccess('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè¯·æ‰‹åŠ¨å¡«å†™å¥åº·è¯ä¿¡æ¯');
                    } else {
                        showError(result.message || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                setButtonLoading(false);
            }
        }

        /**
         * æäº¤å¥åº·è¯
         */
        async function submitCertificate() {
            hideMessages();

            // éªŒè¯å¿…å¡«å­—æ®µ
            const certNumber = document.getElementById('certNumber').value.trim();
            const employeeName = document.getElementById('employeeName').value.trim();
            const issueDate = document.getElementById('issueDate').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const imagePath = currentImagePath;

            if (!certNumber) {
                showError('è¯·è¾“å…¥å¥åº·è¯ç¼–å·');
                document.getElementById('certNumber').focus();
                return;
            }

            if (!employeeName) {
                showError('è¯·è¾“å…¥å§“å');
                document.getElementById('employeeName').focus();
                return;
            }

            if (!issueDate) {
                showError('è¯·é€‰æ‹©å‘è¯æ—¥æœŸ');
                document.getElementById('issueDate').focus();
                return;
            }

            if (!expiryDate) {
                showError('è¯·é€‰æ‹©æœ‰æ•ˆæœŸè‡³');
                document.getElementById('expiryDate').focus();
                return;
            }

            if (!imagePath) {
                showError('è¯·å…ˆä¸Šä¼ å¥åº·è¯å›¾ç‰‡');
                return;
            }

            setButtonLoading(true);

            try {
                // æ„å»ºæäº¤æ•°æ®
                const submitData = {
                    certNumber: certNumber,
                    employeeName: employeeName,
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
                    idCard: document.getElementById('idCard').value.trim(),
                    category: document.getElementById('category').value.trim(),
                    issueDate: issueDate,
                    expiryDate: expiryDate,
                    issuingAuthority: document.getElementById('issuingAuthority').value.trim(),
                    imagePath: imagePath
                };

                // å‘é€æäº¤è¯·æ±‚
                const response = await fetch(API_BASE_URL + '/health-cert/submit', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitData)
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    showSuccess('æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
                    setTimeout(() => {
                        window.location.href = 'employee-home.html';
                    }, 1500);
                } else {
                    showError(result.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    setButtonLoading(false);
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                setButtonLoading(false);
            }
        }

        // æ–‡ä»¶è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        uploadArea.addEventListener('click', function() {
            if (!uploadArea.classList.contains('has-image')) {
                fileInput.click();
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // è¡¨å•æäº¤äº‹ä»¶
        certificateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitCertificate();
        });

        // é¡µé¢åˆå§‹åŒ–
        function init() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!checkLogin()) {
                return;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

