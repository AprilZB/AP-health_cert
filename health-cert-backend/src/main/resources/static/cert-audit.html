<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥å¥åº·è¯ç®¡ç†ç³»ç»Ÿ - å¥åº·è¯ç®¡ç†</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ ï¼ˆå¤ç”¨æ ·å¼ï¼‰ */
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            transition: width 0.3s ease;
            overflow: hidden;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h1 {
            font-size: 18px;
            white-space: nowrap;
        }

        .sidebar.collapsed .sidebar-header h1 {
            display: none;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .nav-menu {
            padding: 10px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.3);
            border-left: 3px solid #667eea;
        }

        .nav-item-icon {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        .sidebar.collapsed .nav-item-icon {
            margin-right: 0;
        }

        .nav-item-text {
            white-space: nowrap;
        }

        .sidebar.collapsed .nav-item-text {
            display: none;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: 60px;
        }

        /* é¡¶éƒ¨æ  */
        .topbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar h2 {
            font-size: 20px;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #e0e0e0;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            padding: 30px;
        }

        /* ç­›é€‰æ  */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            font-size: 14px;
            color: #666;
        }

        .filter-item input,
        .filter-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-item select {
            min-width: 120px;
            cursor: pointer;
        }

        .filter-btn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: #5568d3;
        }

        /* åˆ—è¡¨å¡ç‰‡ */
        .list-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .list-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-header h3 {
            font-size: 16px;
            color: #333;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th,
        .list-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .list-table th {
            background: #fafafa;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .list-table td {
            font-size: 14px;
            color: #666;
        }

        .list-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.expired {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-badge.draft {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .action-btn.audit {
            background: #667eea;
            color: white;
        }

        .action-btn.audit:hover {
            background: #5568d3;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        /* æ¨¡æ€æ¡†ä¸»ä½“å¸ƒå±€ï¼šå·¦å³ä¸¤åˆ— */
        .modal-body-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        /* å·¦ä¾§ä¿¡æ¯åŒºåŸŸ */
        .modal-info-section {
            display: flex;
            flex-direction: column;
        }

        /* å³ä¾§å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        .modal-image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-image-container {
            width: 100%;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-image-container:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .modal-image-container:hover .fullscreen-hint {
            opacity: 1;
        }

        .modal-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 4px;
            display: block;
        }

        .fullscreen-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .image-placeholder {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 8px;
            color: #999;
            font-size: 14px;
        }

        .modal-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .modal-info-item {
            display: flex;
            flex-direction: column;
        }

        .modal-info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .modal-info-value {
            font-size: 14px;
            color: #333;
        }

        .modal-actions {
            padding: 20px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.approve {
            background: #27ae60;
            color: white;
        }

        .modal-btn.approve:hover {
            background: #229954;
        }

        .modal-btn.reject {
            background: #e74c3c;
            color: white;
        }

        .modal-btn.reject:hover {
            background: #c0392b;
        }

        .modal-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }

        .modal-btn.cancel:hover {
            background: #e0e0e0;
        }

        .reject-reason {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 10px;
            min-height: 80px;
            resize: vertical;
        }

        /* åˆ†é¡µ */
        .pagination {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .page-btn:hover {
            background: #f5f5f5;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .sidebar:not(.collapsed) {
                width: 250px;
            }

            .main-content {
                margin-left: 60px;
            }

            .content {
                padding: 15px;
            }

            .list-table {
                font-size: 12px;
            }

            .list-table th,
            .list-table td {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
            }

            .modal-info {
                grid-template-columns: 1fr;
            }

            .modal-body-layout {
                grid-template-columns: 1fr;
            }
        }

        /* å…¨å±é¢„è§ˆæ ·å¼ */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fullscreen-overlay.show {
            display: flex;
        }

        .fullscreen-image {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 36px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .fullscreen-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>å¥åº·è¯ç®¡ç†ç³»ç»Ÿ</h1>
            <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        </div>
        <nav class="nav-menu">
            <div class="nav-item" onclick="navigate('admin-dashboard.html')">
                <span class="nav-item-icon">ğŸ“Š</span>
                <span class="nav-item-text">å·¥ä½œå°</span>
            </div>
            <div class="nav-item active" onclick="navigate('cert-audit.html')">
                <span class="nav-item-icon">ğŸ“‹</span>
                <span class="nav-item-text">å¥åº·è¯ç®¡ç†</span>
            </div>
            <div class="nav-item" onclick="navigate('employee-management.html')">
                <span class="nav-item-icon">ğŸ‘¥</span>
                <span class="nav-item-text">å‘˜å·¥ç®¡ç†</span>
            </div>
            <div class="nav-item" onclick="navigate('department-management.html')">
                <span class="nav-item-icon">ğŸ¢</span>
                <span class="nav-item-text">éƒ¨é—¨ç®¡ç†</span>
            </div>
            <div class="nav-item" onclick="navigate('operation-logs.html')">
                <span class="nav-item-icon">ğŸ“‹</span>
                <span class="nav-item-text">æ“ä½œæ—¥å¿—</span>
            </div>
            <div class="nav-item" onclick="navigate('system-config.html')">
                <span class="nav-item-icon">âš™ï¸</span>
                <span class="nav-item-text">ç³»ç»Ÿé…ç½®</span>
            </div>
        </nav>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- é¡¶éƒ¨æ  -->
        <div class="topbar">
            <h2>å¥åº·è¯ç®¡ç†</h2>
            <div class="user-info">
                <span class="user-name" id="userName">åŠ è½½ä¸­...</span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-item">
                    <label>çŠ¶æ€ï¼š</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="pending">å¾…å®¡æ ¸</option>
                        <option value="approved">å·²é€šè¿‡</option>
                        <option value="rejected">å·²æ‹’ç»</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                        <option value="draft">è‰ç¨¿</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å‘˜å·¥å§“åï¼š</label>
                    <input type="text" id="filterEmployeeName" placeholder="è¯·è¾“å…¥å‘˜å·¥å§“å">
                </div>
                <div class="filter-item">
                    <label>å¥åº·è¯ç¼–å·ï¼š</label>
                    <input type="text" id="filterCertNumber" placeholder="è¯·è¾“å…¥ç¼–å·">
                </div>
                <button class="filter-btn" onclick="loadHealthCertList()">æŸ¥è¯¢</button>
            </div>

            <!-- å¥åº·è¯åˆ—è¡¨ -->
            <div class="list-card">
                <div class="list-header">
                    <h3>å¥åº·è¯åˆ—è¡¨</h3>
                </div>
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>å‘˜å·¥å§“å</th>
                            <th>å¥åº·è¯ç¼–å·</th>
                            <th>çŠ¶æ€</th>
                            <th>å‘è¯æ—¥æœŸ</th>
                            <th>æœ‰æ•ˆæœŸè‡³</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="healthCertListBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <!-- å®¡æ ¸/æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="auditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">å®¡æ ¸å¥åº·è¯</h3>
                <button class="modal-close" onclick="closeAuditModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- åŠ¨æ€å¡«å……å†…å®¹ -->
            </div>
            <div class="modal-actions" id="modalActions">
                <button class="modal-btn approve" id="approveBtn" onclick="approveCertificate()" style="display: none;">é€šè¿‡</button>
                <button class="modal-btn reject" id="rejectBtn" onclick="showRejectReason()" style="display: none;">æ‹’ç»</button>
                <button class="modal-btn cancel" onclick="closeAuditModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å…¨å±å›¾ç‰‡é¢„è§ˆ -->
    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
        <button class="fullscreen-close" onclick="closeFullscreen()">Ã—</button>
        <img class="fullscreen-image" id="fullscreenImage" src="" alt="å¥åº·è¯å›¾ç‰‡" onclick="event.stopPropagation()">
    </div>

    <script>
        // APIåŸºç¡€åœ°å€
        const API_BASE_URL = '/api';

        // å½“å‰é¡µç å’Œæ¯é¡µå¤§å°
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;

        // å½“å‰å®¡æ ¸çš„å¥åº·è¯ID
        let currentAuditCertId = null;
        let currentViewCertId = null;
        let isRejectMode = false;
        let isViewMode = false; // æ˜¯å¦ä¸ºæŸ¥çœ‹æ¨¡å¼ï¼ˆéå®¡æ ¸æ¨¡å¼ï¼‰

        /**
         * è·å–Token
         */
        function getToken() {
            return localStorage.getItem('token');
        }

        /**
         * æ£€æŸ¥ç™»å½•çŠ¶æ€
         */
        function checkLogin() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        /**
         * åˆ‡æ¢ä¾§è¾¹æ 
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        /**
         * å¯¼èˆªåˆ°æŒ‡å®šé¡µé¢
         */
        function navigate(url) {
            window.location.href = url;
        }

        /**
         * é€€å‡ºç™»å½•
         */
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            localStorage.removeItem('userType');
            window.location.href = 'login.html';
        }

        /**
         * æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
         */
        function displayUserInfo() {
            const username = localStorage.getItem('username') || 'ç®¡ç†å‘˜';
            document.getElementById('userName').textContent = username;
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸ
         */
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
         */
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        /**
         * è·å–çŠ¶æ€æ–‡æœ¬
         */
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å®¡æ ¸',
                'approved': 'å·²é€šè¿‡',
                'rejected': 'å·²æ‹’ç»',
                'expired': 'å·²è¿‡æœŸ',
                'draft': 'è‰ç¨¿'
            };
            return statusMap[status] || status || '-';
        }

        /**
         * è·å–çŠ¶æ€æ ·å¼ç±»
         */
        function getStatusClass(status) {
            return status ? `status-badge ${status}` : '';
        }

        /**
         * åŠ è½½å¥åº·è¯åˆ—è¡¨
         */
        async function loadHealthCertList(page = 1) {
            currentPage = page;
            const tbody = document.getElementById('healthCertListBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">åŠ è½½ä¸­...</td></tr>';

            try {
                // è·å–ç­›é€‰æ¡ä»¶
                const status = document.getElementById('filterStatus').value.trim();
                const employeeName = document.getElementById('filterEmployeeName').value.trim();
                const certNumber = document.getElementById('filterCertNumber').value.trim();

                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let url = `${API_BASE_URL}/admin/health-cert/list?page=${page}&size=${pageSize}`;
                if (status) {
                    url += `&status=${encodeURIComponent(status)}`;
                }
                if (employeeName) {
                    url += `&employeeName=${encodeURIComponent(employeeName)}`;
                }
                if (certNumber) {
                    url += `&certNumber=${encodeURIComponent(certNumber)}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    const pageData = result.data || {};
                    const records = pageData.records || [];
                    totalPages = pageData.pages || 1;

                    if (records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">æš‚æ— å¥åº·è¯è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = records.map(cert => {
                            const statusText = getStatusText(cert.status);
                            const statusClass = getStatusClass(cert.status);
                            const actionBtn = cert.status === 'pending' 
                                ? `<button class="action-btn audit" onclick="openAuditModal(${cert.id})">å®¡æ ¸</button>`
                                : `<button class="action-btn audit" onclick="openViewModal(${cert.id})">æŸ¥çœ‹</button>`;
                            
                            return `
                                <tr>
                                    <td>${cert.id || '-'}</td>
                                    <td>${cert.employeeName || '-'}</td>
                                    <td>${cert.certNumber || '-'}</td>
                                    <td><span class="${statusClass}">${statusText}</span></td>
                                    <td>${formatDate(cert.issueDate)}</td>
                                    <td>${formatDate(cert.expiryDate)}</td>
                                    <td>${formatDateTime(cert.submitTime)}</td>
                                    <td>${actionBtn}</td>
                                </tr>
                            `;
                        }).join('');
                    }

                    // æ›´æ–°åˆ†é¡µ
                    updatePagination();
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #c33;">åŠ è½½å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½å¥åº·è¯åˆ—è¡¨å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #c33;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</td></tr>';
            }
        }

        /**
         * æ›´æ–°åˆ†é¡µ
         */
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button class="page-btn" onclick="loadHealthCertList(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;

            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadHealthCertList(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button class="page-btn" onclick="loadHealthCertList(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

            pagination.innerHTML = html;
        }

        /**
         * æ‰“å¼€å®¡æ ¸æ¨¡æ€æ¡†
         */
        async function openAuditModal(certId) {
            currentAuditCertId = certId;
            isRejectMode = false;
            // å¦‚æœisViewModeæœªè®¾ç½®ï¼Œæ ¹æ®certIdåˆ¤æ–­ï¼ˆå¦‚æœæ˜¯ä»openViewModalè°ƒç”¨ï¼ŒisViewModeåº”è¯¥å·²ç»è®¾ç½®ä¸ºtrueï¼‰
            // å¦åˆ™é»˜è®¤ä¸ºfalseï¼ˆå®¡æ ¸æ¨¡å¼ï¼‰

            try {
                // è·å–å¥åº·è¯è¯¦æƒ…ï¼ˆä»åˆ—è¡¨ä¸­æŸ¥æ‰¾æˆ–é‡æ–°æŸ¥è¯¢ï¼‰
                const listResponse = await fetch(`${API_BASE_URL}/admin/health-cert/list?page=1&size=1000`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    }
                });

                if (!listResponse.ok) {
                    const errorResult = await listResponse.json();
                    throw new Error(errorResult.message || 'è·å–å¥åº·è¯åˆ—è¡¨å¤±è´¥');
                }

                const listResult = await listResponse.json();

                if (listResult.code !== 200) {
                    throw new Error(listResult.message || 'è·å–å¥åº·è¯åˆ—è¡¨å¤±è´¥');
                }

                const cert = (listResult.data?.records || []).find(c => c.id === certId);

                if (!cert) {
                    alert('æœªæ‰¾åˆ°å¥åº·è¯ä¿¡æ¯');
                    return;
                }

                // æ ¹æ®çŠ¶æ€å†³å®šæ˜¯å¦éœ€è¦é”å®šï¼ˆåªæœ‰å¾…å®¡æ ¸çŠ¶æ€ä¸”éæŸ¥çœ‹æ¨¡å¼æ‰éœ€è¦é”å®šï¼‰
                // å¦‚æœisViewModeæœªå®šä¹‰ï¼Œåˆ™æ ¹æ®çŠ¶æ€åˆ¤æ–­ï¼šépendingçŠ¶æ€é»˜è®¤ä¸ºæŸ¥çœ‹æ¨¡å¼
                if (isViewMode === undefined) {
                    isViewMode = cert.status !== 'pending';
                }

                if (!isViewMode && cert.status === 'pending') {
                    const lockResponse = await fetch(`${API_BASE_URL}/admin/health-cert/lock/${certId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + getToken(),
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!lockResponse.ok) {
                        const lockResult = await lockResponse.json();
                        alert(lockResult.message || 'é”å®šå¤±è´¥ï¼Œè¯¥å¥åº·è¯å¯èƒ½å·²è¢«å…¶ä»–ç®¡ç†å‘˜é”å®š');
                        return;
                    }
                }

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modalBody = document.getElementById('modalBody');
                // æ„å»ºå›¾ç‰‡URLï¼šå¦‚æœimagePathæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ 2024/12/uuid.jpgï¼‰ï¼Œéœ€è¦åŠ ä¸Š /uploads/ å‰ç¼€
                let imageUrl = '';
                if (cert.imagePath) {
                    console.log('åŸå§‹imagePath:', cert.imagePath);
                    if (cert.imagePath.startsWith('http')) {
                        // å·²ç»æ˜¯å®Œæ•´URL
                        imageUrl = cert.imagePath;
                    } else if (cert.imagePath.startsWith('/')) {
                        // å·²ç»æ˜¯ç»å¯¹è·¯å¾„
                        imageUrl = cert.imagePath;
                    } else {
                        // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸Š /uploads/ å‰ç¼€
                        // ç»Ÿä¸€ä½¿ç”¨æ­£æ–œæ ï¼Œå¹¶ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                        const normalizedPath = cert.imagePath.replace(/\\/g, '/');
                        imageUrl = '/uploads/' + normalizedPath;
                    }
                    console.log('æ„å»ºçš„imageUrl:', imageUrl);
                } else {
                    console.warn('cert.imagePathä¸ºç©º');
                }

                modalBody.innerHTML = `
                    <div class="modal-body-layout">
                        <!-- å·¦ä¾§ï¼šå¥åº·è¯ä¿¡æ¯ -->
                        <div class="modal-info-section">
                            <div class="modal-info">
                                <div class="modal-info-item">
                                    <div class="modal-info-label">å¥åº·è¯ç¼–å·</div>
                                    <div class="modal-info-value">${cert.certNumber || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">å‘˜å·¥å§“å</div>
                                    <div class="modal-info-value">${cert.employeeName || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">æ€§åˆ«</div>
                                    <div class="modal-info-value">${cert.gender || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">å¹´é¾„</div>
                                    <div class="modal-info-value">${cert.age || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">èº«ä»½è¯å·</div>
                                    <div class="modal-info-value">${cert.idCard || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">å¥åº·è¯ç±»åˆ«</div>
                                    <div class="modal-info-value">${cert.category || '-'}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">å‘è¯æ—¥æœŸ</div>
                                    <div class="modal-info-value">${formatDate(cert.issueDate)}</div>
                                </div>
                                <div class="modal-info-item">
                                    <div class="modal-info-label">æœ‰æ•ˆæœŸè‡³</div>
                                    <div class="modal-info-value">${formatDate(cert.expiryDate)}</div>
                                </div>
                                <div class="modal-info-item" style="grid-column: 1 / -1;">
                                    <div class="modal-info-label">å‘è¯æœºæ„</div>
                                    <div class="modal-info-value">${cert.issuingAuthority || '-'}</div>
                                </div>
                                ${cert.status !== 'pending' && cert.status !== 'draft' ? `
                                    <div class="modal-info-item" style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                                        <div class="modal-info-label">å®¡æ ¸ä¿¡æ¯</div>
                                        <div style="margin-top: 8px;">
                                            ${cert.auditorName ? `<div style="margin-bottom: 5px;">å®¡æ ¸äººï¼š${cert.auditorName}</div>` : ''}
                                            ${cert.auditTime ? `<div style="margin-bottom: 5px;">å®¡æ ¸æ—¶é—´ï¼š${formatDateTime(cert.auditTime)}</div>` : ''}
                                            ${cert.status === 'rejected' && cert.rejectReason ? `<div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 6px; color: #721c24;">æ‹’ç»åŸå› ï¼š${cert.rejectReason}</div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div id="rejectReasonSection" style="display: none; margin-top: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">æ‹’ç»åŸå›  <span style="color: #f00;">*</span></label>
                                <textarea id="rejectReason" class="reject-reason" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› "></textarea>
                            </div>
                        </div>
                        <!-- å³ä¾§ï¼šå¥åº·è¯å›¾ç‰‡é¢„è§ˆ -->
                        <div class="modal-image-section">
                            ${imageUrl ? `
                                <div class="modal-image-container" onclick="openFullscreen('${imageUrl}')">
                                    <img src="${imageUrl}" alt="å¥åº·è¯å›¾ç‰‡" class="modal-image" 
                                         onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼ŒURL:', '${imageUrl}'); this.parentElement.innerHTML='<div class=\\'image-placeholder\\'>å›¾ç‰‡åŠ è½½å¤±è´¥<br/>URL: ${imageUrl}</div>'"
                                         onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸï¼ŒURL:', '${imageUrl}')">
                                    <div class="fullscreen-hint">ç‚¹å‡»å›¾ç‰‡å…¨å±é¢„è§ˆ</div>
                                </div>
                            ` : `
                                <div class="image-placeholder">æš‚æ— å›¾ç‰‡</div>
                            `}
                        </div>
                    </div>
                `;

                // æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—å®¡æ ¸æŒ‰é’®
                const approveBtn = document.getElementById('approveBtn');
                const rejectBtn = document.getElementById('rejectBtn');
                const modalTitle = document.getElementById('modalTitle');
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!approveBtn || !rejectBtn || !modalTitle) {
                    console.error('æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°:', { approveBtn, rejectBtn, modalTitle });
                    throw new Error('æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                }
                
                if (cert.status === 'pending' && !isViewMode) {
                    // å¾…å®¡æ ¸çŠ¶æ€ï¼Œæ˜¾ç¤ºå®¡æ ¸æŒ‰é’®
                    modalTitle.textContent = 'å®¡æ ¸å¥åº·è¯';
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                } else {
                    // å…¶ä»–çŠ¶æ€ï¼Œåªæ˜¾ç¤ºæŸ¥çœ‹
                    modalTitle.textContent = 'æŸ¥çœ‹å¥åº·è¯';
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }

                document.getElementById('auditModal').classList.add('show');
            } catch (error) {
                console.error('æ‰“å¼€å®¡æ ¸/æŸ¥çœ‹æ¨¡æ€æ¡†å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                alert('åŠ è½½å¥åº·è¯ä¿¡æ¯å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        /**
         * æ‰“å¼€æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆéå¾…å®¡æ ¸çŠ¶æ€ï¼‰
         */
        async function openViewModal(certId) {
            currentViewCertId = certId;
            isViewMode = true;
            isRejectMode = false;
            
            // å¤ç”¨openAuditModalçš„é€»è¾‘ï¼Œä½†ä¼šé€šè¿‡isViewModeæ§åˆ¶æŒ‰é’®æ˜¾ç¤º
            await openAuditModal(certId);
        }

        /**
         * å…³é—­å®¡æ ¸æ¨¡æ€æ¡†
         */
        function closeAuditModal() {
            document.getElementById('auditModal').classList.remove('show');
            currentAuditCertId = null;
            currentViewCertId = null;
            isRejectMode = false;
            isViewMode = false;
            // é‡ç½®æ‹’ç»æŒ‰é’®
            const rejectBtn = document.getElementById('rejectBtn');
            if (rejectBtn) {
                rejectBtn.textContent = 'æ‹’ç»';
                rejectBtn.onclick = showRejectReason;
            }
        }

        /**
         * æ˜¾ç¤ºæ‹’ç»åŸå› è¾“å…¥æ¡†
         */
        function showRejectReason() {
            isRejectMode = true;
            document.getElementById('rejectReasonSection').style.display = 'block';
            const rejectBtn = document.getElementById('rejectBtn');
            rejectBtn.textContent = 'ç¡®è®¤æ‹’ç»';
            rejectBtn.onclick = rejectCertificate;
        }

        /**
         * é€šè¿‡å®¡æ ¸
         */
        async function approveCertificate() {
            if (!currentAuditCertId) {
                return;
            }

            if (!confirm('ç¡®è®¤é€šè¿‡è¯¥å¥åº·è¯å®¡æ ¸ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/health-cert/audit/${currentAuditCertId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'approve',
                        reason: ''
                    })
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    alert('å®¡æ ¸é€šè¿‡æˆåŠŸ');
                    closeAuditModal();
                    loadHealthCertList(currentPage);
                } else {
                    alert(result.message || 'å®¡æ ¸å¤±è´¥');
                }
            } catch (error) {
                console.error('å®¡æ ¸å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        /**
         * æ‹’ç»å®¡æ ¸
         */
        async function rejectCertificate() {
            if (!currentAuditCertId) {
                return;
            }

            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                alert('è¯·è¾“å…¥æ‹’ç»åŸå› ');
                document.getElementById('rejectReason').focus();
                return;
            }

            if (!confirm('ç¡®è®¤æ‹’ç»è¯¥å¥åº·è¯å®¡æ ¸ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/health-cert/audit/${currentAuditCertId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'reject',
                        reason: reason
                    })
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    alert('å®¡æ ¸æ‹’ç»æˆåŠŸ');
                    closeAuditModal();
                    loadHealthCertList(currentPage);
                } else {
                    alert(result.message || 'å®¡æ ¸å¤±è´¥');
                }
            } catch (error) {
                console.error('å®¡æ ¸å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }


        /**
         * æ‰“å¼€å…¨å±é¢„è§ˆ
         */
        function openFullscreen(imageUrl) {
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');
            img.src = imageUrl;
            overlay.classList.add('show');
            // é˜»æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }

        /**
         * å…³é—­å…¨å±é¢„è§ˆ
         */
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('show');
            // æ¢å¤bodyæ»šåŠ¨
            document.body.style.overflow = '';
        }

        /**
         * é¡µé¢åˆå§‹åŒ–
         */
        function init() {
            if (!checkLogin()) {
                return;
            }

            displayUserInfo();
            loadHealthCertList();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('auditModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAuditModal();
            }
        });

        // æŒ‰ESCé”®å…³é—­å…¨å±é¢„è§ˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('fullscreenOverlay');
                if (overlay.classList.contains('show')) {
                    closeFullscreen();
                }
            }
        });
    </script>
</body>
</html>

